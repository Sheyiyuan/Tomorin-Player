name: Build & Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build-linux-windows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --tags --force --prune

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm i -g pnpm

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev libgtk-3-dev libwebkit2gtk-4.1-dev icoutils imagemagick nsis gcc-mingw-w64-x86-64 ruby ruby-dev rubygems rpm
          # Wails 仍查找 4.0 名称，手动创建兼容软链接（若已存在则忽略）
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc || true
          sudo gem install --no-document fpm

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Make scripts executable
        run: |
          chmod +x scripts/build-deb.sh scripts/build-rpm.sh scripts/windows/build-windows.sh scripts/derive-version.sh scripts/generate-icons.sh

      - name: Derive version (tag -> release, main -> x.y.(z+1)-dev.date.hash)
        id: version
        run: |
          VERSION=$(bash scripts/derive-version.sh)
          echo "Final version: ${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
      
      - name: Frontend build (inject version)
        env:
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd frontend
          pnpm install
          pnpm build

      - name: Build Linux binary (inject version)
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          wails build -clean -platform linux/amd64

      - name: Package Debian .deb
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          bash scripts/build-deb.sh
        shell: bash

      - name: Package RPM
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          bash scripts/build-rpm.sh
        shell: bash

      - name: Build Windows (cross-compile + NSIS)
        env:
          CGO_ENABLED: '1'
          CC: x86_64-w64-mingw32-gcc
          CXX: x86_64-w64-mingw32-g++
          APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Ensure frontend is fresh before Windows build
          cd frontend && pnpm install && pnpm build && cd ..
          bash scripts/windows/build-windows.sh -c

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: half-beat-${{ steps.version.outputs.version }}
          path: |
            build/deb/*.deb
            build/rpm/*.rpm
            build/bin/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --tags --force --prune

      - name: Make scripts executable
        run: chmod +x scripts/build-macos.sh scripts/derive-version.sh

      - name: Derive version (tag -> release, main -> x.y.(z+1)-dev.date.hash)
        id: version
        run: |
          VERSION=$(bash scripts/derive-version.sh)
          echo "Final version: ${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm i -g pnpm

      - name: Install tooling
        run: |
          brew install jq create-dmg || true

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Make scripts executable
        run: chmod +x scripts/build-macos.sh

      - name: Frontend build (inject version)
        env:
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd frontend
          pnpm install
          pnpm build

      - name: Build macOS (universal)
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          scripts/build-macos.sh -c

      - name: Upload Artifacts (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: half-beat-macos-${{ steps.version.outputs.version }}
          path: |
            build/bin/*.dmg
            build/bin/*.app

  release:
    needs: [build-linux-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --tags --force --prune

      - name: Make scripts executable
        run: chmod +x scripts/derive-version.sh

      - name: Derive release metadata (tag -> release, main -> dev-latest)
        id: meta
        run: |
          VERSION=$(bash scripts/derive-version.sh)
          
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
            PRERELEASE=false
            NAME="Release ${VERSION}"
          else
            TAG="dev-latest"
            PRERELEASE=true
            NAME="Development Build ${VERSION}"
          fi
          
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          
          echo "Release metadata:"
          echo "  Version: ${VERSION}"
          echo "  Tag: ${TAG}"
          echo "  Prerelease: ${PRERELEASE}"
          echo "  Name: ${NAME}"

      - name: Remove previous dev release/tag
        if: ${{ steps.meta.outputs.tag == 'dev-latest' }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = 'dev-latest';
            // delete release if exists
            try {
              const rel = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              await github.rest.repos.deleteRelease({ owner, repo, release_id: rel.data.id });
            } catch (e) { /* ignore if not exists */ }
            // delete tag ref if exists
            try {
              await github.rest.git.deleteRef({ owner, repo, ref: `tags/${tag}` });
            } catch (e) { /* ignore if not exists */ }

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          prerelease: ${{ steps.meta.outputs.prerelease }}
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
